{{- /*
Where: deploy/helm/miniserversystem-platform/templates/istio-destinationrules.yaml
What: DestinationRules for infra dependencies and gateway downstream resilience policies.
Why: Keep non-mesh plaintext routing and apply connection-level protection for internal dependencies.
*/ -}}
{{- if .Values.istio.enabled }}
apiVersion: networking.istio.io/v1
kind: DestinationRule
metadata:
  name: nats-plaintext
spec:
  host: nats.{{ .Release.Namespace }}.svc.cluster.local
  trafficPolicy:
    tls:
      mode: DISABLE
{{- if .Values.istio.gatewayToAccountCircuitBreaker.enabled }}
---
apiVersion: networking.istio.io/v1
kind: DestinationRule
metadata:
  name: account-circuit-breaker
spec:
  host: account.{{ .Release.Namespace }}.svc.cluster.local
  trafficPolicy:
    connectionPool:
      tcp:
        maxConnections: {{ default 100 .Values.istio.gatewayToAccountCircuitBreaker.connectionPool.tcp.maxConnections }}
        connectTimeout: {{ default "1s" .Values.istio.gatewayToAccountCircuitBreaker.connectionPool.tcp.connectTimeout | quote }}
      http:
        http1MaxPendingRequests: {{ default 50 .Values.istio.gatewayToAccountCircuitBreaker.connectionPool.http.http1MaxPendingRequests }}
        maxRequestsPerConnection: {{ default 20 .Values.istio.gatewayToAccountCircuitBreaker.connectionPool.http.maxRequestsPerConnection }}
        maxRetries: {{ default 3 .Values.istio.gatewayToAccountCircuitBreaker.connectionPool.http.maxRetries }}
    outlierDetection:
      consecutive5xxErrors: {{ default 5 .Values.istio.gatewayToAccountCircuitBreaker.outlierDetection.consecutive5xxErrors }}
      interval: {{ default "10s" .Values.istio.gatewayToAccountCircuitBreaker.outlierDetection.interval | quote }}
      baseEjectionTime: {{ default "30s" .Values.istio.gatewayToAccountCircuitBreaker.outlierDetection.baseEjectionTime | quote }}
      maxEjectionPercent: {{ default 50 .Values.istio.gatewayToAccountCircuitBreaker.outlierDetection.maxEjectionPercent }}
      minHealthPercent: {{ default 0 .Values.istio.gatewayToAccountCircuitBreaker.outlierDetection.minHealthPercent }}
{{- end }}
{{- if .Values.istio.gatewayToMatchmakingCircuitBreaker.enabled }}
---
apiVersion: networking.istio.io/v1
kind: DestinationRule
metadata:
  name: matchmaking-circuit-breaker
spec:
  host: matchmaking.{{ .Release.Namespace }}.svc.cluster.local
  trafficPolicy:
    connectionPool:
      tcp:
        maxConnections: {{ default 100 .Values.istio.gatewayToMatchmakingCircuitBreaker.connectionPool.tcp.maxConnections }}
        connectTimeout: {{ default "1s" .Values.istio.gatewayToMatchmakingCircuitBreaker.connectionPool.tcp.connectTimeout | quote }}
      http:
        http1MaxPendingRequests: {{ default 50 .Values.istio.gatewayToMatchmakingCircuitBreaker.connectionPool.http.http1MaxPendingRequests }}
        maxRequestsPerConnection: {{ default 20 .Values.istio.gatewayToMatchmakingCircuitBreaker.connectionPool.http.maxRequestsPerConnection }}
        maxRetries: {{ default 3 .Values.istio.gatewayToMatchmakingCircuitBreaker.connectionPool.http.maxRetries }}
    outlierDetection:
      consecutive5xxErrors: {{ default 5 .Values.istio.gatewayToMatchmakingCircuitBreaker.outlierDetection.consecutive5xxErrors }}
      interval: {{ default "10s" .Values.istio.gatewayToMatchmakingCircuitBreaker.outlierDetection.interval | quote }}
      baseEjectionTime: {{ default "30s" .Values.istio.gatewayToMatchmakingCircuitBreaker.outlierDetection.baseEjectionTime | quote }}
      maxEjectionPercent: {{ default 50 .Values.istio.gatewayToMatchmakingCircuitBreaker.outlierDetection.maxEjectionPercent }}
      minHealthPercent: {{ default 0 .Values.istio.gatewayToMatchmakingCircuitBreaker.outlierDetection.minHealthPercent }}
{{- end }}
{{- if .Values.istio.gatewayToEntitlementCircuitBreaker.enabled }}
---
apiVersion: networking.istio.io/v1
kind: DestinationRule
metadata:
  name: entitlement-circuit-breaker
spec:
  host: entitlement.{{ .Release.Namespace }}.svc.cluster.local
  trafficPolicy:
    connectionPool:
      tcp:
        maxConnections: {{ default 100 .Values.istio.gatewayToEntitlementCircuitBreaker.connectionPool.tcp.maxConnections }}
        connectTimeout: {{ default "1s" .Values.istio.gatewayToEntitlementCircuitBreaker.connectionPool.tcp.connectTimeout | quote }}
      http:
        http1MaxPendingRequests: {{ default 50 .Values.istio.gatewayToEntitlementCircuitBreaker.connectionPool.http.http1MaxPendingRequests }}
        maxRequestsPerConnection: {{ default 20 .Values.istio.gatewayToEntitlementCircuitBreaker.connectionPool.http.maxRequestsPerConnection }}
        maxRetries: {{ default 3 .Values.istio.gatewayToEntitlementCircuitBreaker.connectionPool.http.maxRetries }}
    outlierDetection:
      consecutive5xxErrors: {{ default 5 .Values.istio.gatewayToEntitlementCircuitBreaker.outlierDetection.consecutive5xxErrors }}
      interval: {{ default "10s" .Values.istio.gatewayToEntitlementCircuitBreaker.outlierDetection.interval | quote }}
      baseEjectionTime: {{ default "30s" .Values.istio.gatewayToEntitlementCircuitBreaker.outlierDetection.baseEjectionTime | quote }}
      maxEjectionPercent: {{ default 50 .Values.istio.gatewayToEntitlementCircuitBreaker.outlierDetection.maxEjectionPercent }}
      minHealthPercent: {{ default 0 .Values.istio.gatewayToEntitlementCircuitBreaker.outlierDetection.minHealthPercent }}
{{- end }}
{{- end }}
