# Where: deploy/kustomize/infra/base/network-policies.yaml
# What: Restrict inbound access to infra dependencies (PostgreSQL/NATS/Redis).
# Why: These dependencies are outside service mesh mTLS/AuthZ scope; enforce least privilege with NetworkPolicy.
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: postgres-allow-apps-only
  namespace: miniserversystem
spec:
  podSelector:
    matchLabels:
      app: postgres
  policyTypes:
    - Ingress
  ingress:
    - from:
        - podSelector:
            matchExpressions:
              - key: app
                operator: In
                values:
                  - account
                  - entitlement
                  - notification
      ports:
        - protocol: TCP
          port: 5432
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: nats-allow-apps-only
  namespace: miniserversystem
spec:
  podSelector:
    matchLabels:
      app: nats
  policyTypes:
    - Ingress
  ingress:
    - from:
        - podSelector:
            matchExpressions:
              - key: app
                operator: In
                values:
                  - entitlement
                  - notification
                  - matchmaking
      ports:
        - protocol: TCP
          port: 4222
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: redis-allow-matchmaking-only
  namespace: miniserversystem
spec:
  podSelector:
    matchLabels:
      app: redis
  policyTypes:
    - Ingress
  ingress:
    - from:
        - podSelector:
            matchLabels:
              app: matchmaking
      ports:
        - protocol: TCP
          port: 6379
